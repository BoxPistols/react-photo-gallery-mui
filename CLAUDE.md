# CLAUDE.md

このファイルは、Claude Code (claude.ai/code)がこのリポジトリのコードを扱う際のガイダンスを提供します。

## プロジェクト概要

これは、Next.js 15、TypeScript 5.7、Material-UI 7.3を使用して構築されたモダンなReactフォトギャラリーアプリケーションです。アプリケーションはPhotoSwipe 5.4を統合して高度なライトボックス機能を実現し、カスタム画像ズーム機能を備えています。ドローン検査ワークフロー専用に設計されており、撮影日、場所、ドローンモデル、検査ステータスタグなどの豊富なメタデータと共に画像を表示します。

## 開発コマンド

- `pnpm dev` - ポート3000でNext.js開発サーバーを開始
- `pnpm build` - 本番用にNext.jsアプリケーションをビルド
- `pnpm start` - 本番サーバーを開始
- `pnpm type-check` - コンパイルなしでTypeScript型チェックを実行
- `pnpm test` - ウォッチモードでVitestテストを実行
- `pnpm test --run` - ウォッチモードなしでテストを一度実行
- `pnpm test:ui` - ポート51204でVitest UIを使用してテストを実行
- `pnpm test:coverage` - カバレッジレポート付きでテストを実行
- `pnpm storybook` - ポート6006でStorybook開発サーバーを開始
- `pnpm build-storybook` - 本番用にStorybookをビルド
- `pnpm lint-all` - すべてのTypeScript/JavaScriptファイルでESLintを実行（警告ゼロ）
- `pnpm lint-all:fix` - リンティング問題を自動修正
- `pnpm format` - Prettierでコードをフォーマット
- `pnpm format:check` - ファイルを変更せずにコードフォーマットをチェック
- `pnpm fix` - リンティングとフォーマット修正を順次実行
- `pnpm check` - 包括的チェックを実行：型チェック、リント、フォーマット検証

## アーキテクチャ

### コアコンポーネント構造

**DroneInspectionGallery** (`src/components/gallery/drone-inspection-gallery.tsx`) - MUI ImageListとPhotoSwipe統合を組み合わせたメインギャラリーコンポーネント。レスポンシブグリッドレイアウト、メタデータ表示、モーダルインタラクションを処理します。Material-UIのレスポンシブブレークポイントシステムを使用し、カスタムImageZoomコンポーネントと統合されています。

**ImageZoom** (`src/components/gallery/image-zoom.tsx`) - クリックズーム、パン、ホイールズーム機能を備えた高度なズームコンポーネント。カーソル位置に基づく精密なズームポジショニングを実装し、スムーズなトランジションを提供します。ズームコントロールとポジションインジケーターを備えています。

**HomePageContent** (`src/components/home-page-content.tsx`) - PhotoSwipe互換性のためにSSRを無効にしたギャラリーコンポーネントの動的インポートを処理するクライアントコンポーネントラッパー。

### 型システムアーキテクチャ

**Gallery Types** (`src/types/gallery.ts`) - 包括的な型定義：

- `GalleryItem` - メタデータサポートを備えたメディアアイテムのコアインターフェース
- `DroneInspectionMetadata` - ドローン固有のメタデータ構造
- `FilterCriteria` - 検査データの高度なフィルタリング機能
- `ExportOptions` - マルチフォーマットエクスポート機能
- 状態管理のためのコンテキストとフックインターフェース

### Next.js App Router構造

- **サーバーコンポーネント**: ルートレイアウトがテーマとクエリプロバイダーを提供
- **クライアントコンポーネント**: インタラクティブコンポーネントは`'use client'`ディレクティブを使用
- **動的インポート**: PhotoSwipeコンポーネントは`ssr: false`でロードされ、サーバーサイドの問題を回避
- **メタデータ**: SEO最適化のためにページレベルで処理

### MUIテーマ統合

`src/lib/theme.ts`のカスタムテーマ設定：

- ImageListItemのホバーエフェクトとトランジション
- フルスクリーンモーダルのダイアログスタイリング
- 一貫したデザイントークン（色、スペーシング、ボーダー）
- SSRシリアライゼーション問題を避けるためのクライアントサイドテーマ作成

## 主要な技術パターン

### SSR互換性

- PhotoSwipeコンポーネントは`ssr: false`で動的インポートにラップ
- テーマとレイアウトコンポーネントはクライアントコンポーネントとしてマーク
- メタデータエクスポートはサーバーコンポーネント（ページ）で処理

### 状態管理

- サーバー状態とキャッシュのためのReact Query
- クライアントサイド状態管理のためのZustand
- コンポーネント間のギャラリー状態のためのコンテキストプロバイダー

### レスポンシブデザイン

- MUIブレークポイントシステム統合
- 設定可能な列を持つレスポンシブ画像グリッド
- モバイル最適化されたズームとナビゲーションコントロール

### パフォーマンス最適化

- MUI ImageListによる画像の遅延読み込み
- 効率的なサムネイル生成
- インクリメンタルTypeScriptコンパイル（tsbuildinfo）

## Photoギャラリー技術スタック詳細解説

### 1. PhotoSwipe 5.4 統合

**PhotoSwipe**は、モダンなWeb標準を使用した高性能なライトボックスライブラリです。

#### 主要機能

- **Lightbox**: フルスクリーン画像表示とスムーズなトランジション
- **タッチジェスチャー**: モバイルデバイスでのスワイプ、ピンチズーム対応
- **キーボードナビゲーション**: 矢印キー、ESCキーでの操作
- **アクセシビリティ**: スクリーンリーダー対応、ARIA属性サポート

#### 技術的特徴

- **ES Modules**: モダンなJavaScriptモジュールシステム
- **TypeScript**: 完全な型定義サポート
- **CSS Grid**: レスポンシブレイアウトシステム
- **Intersection Observer**: 効率的なビューポート検出

### 2. Material-UI ImageList 統合

**MUI ImageList**は、画像ギャラリーの基盤となるグリッドシステムを提供します。

#### レイアウトシステム

- **レスポンシブグリッド**: ブレークポイントに応じた列数の自動調整
- **アスペクト比保持**: 画像の歪みを防ぐための適応的レイアウト
- **ギャップ制御**: 画像間の一貫したスペーシング

#### パフォーマンス最適化

- **遅延読み込み**: ビューポート内の画像のみをロード
- **サムネイル最適化**: 高解像度画像の効率的な表示
- **メモリ管理**: 非表示画像の適切なアンロード

### 3. カスタム画像ズーム機能

**ImageZoom**コンポーネントは、高度なズーム機能を提供します。

#### ズーム機能

- **クリックズーム**: マウスクリック位置を中心としたズーム
- **ホイールズーム**: マウスホイールによる段階的ズーム
- **パン機能**: ズーム後の画像移動
- **ズーム制限**: 最小・最大ズームレベルの制御

#### 技術実装

- **Canvas API**: 高パフォーマンスな画像処理
- **Transform Matrix**: CSS transformによるスムーズなアニメーション
- **イベント処理**: タッチとマウスイベントの統一処理
- **メモリ最適化**: 大きな画像の効率的な処理

### 4. レスポンシブデザインシステム

#### ブレークポイント戦略

```typescript
// MUIブレークポイントシステム
xs: 0px      // モバイル（縦向き）
sm: 600px    // モバイル（横向き）
md: 900px    // タブレット
lg: 1200px   // デスクトップ
xl: 1536px   // 大画面デスクトップ
```

#### グリッドレイアウト

- **1列**: モバイル（xs）
- **2列**: タブレット（sm, md）
- **3列**: デスクトップ（lg）
- **4列**: 大画面（xl）

### 5. 画像最適化戦略

#### フォーマット最適化

- **WebP**: モダンブラウザでの高圧縮率
- **JPEG**: 広いブラウザ互換性
- **PNG**: 透明度が必要な場合

#### サイズ最適化

- **サムネイル**: 150x150px（グリッド表示用）
- **プレビュー**: 800x600px（モーダル表示用）
- **フル解像度**: 元画像サイズ（ダウンロード用）

### 6. 状態管理アーキテクチャ

#### React Query統合

```typescript
// 画像メタデータのキャッシュ管理
const { data: galleryItems } = useQuery({
  queryKey: ['gallery', filterCriteria],
  queryFn: fetchGalleryItems,
  staleTime: 5 * 60 * 1000, // 5分間キャッシュ
})
```

#### Zustand状態管理

```typescript
// ギャラリーUI状態の管理
interface GalleryState {
  selectedImage: GalleryItem | null
  zoomLevel: number
  isFullscreen: boolean
  filterCriteria: FilterCriteria
}
```

### 7. パフォーマンス最適化

#### 画像遅延読み込み

- **Intersection Observer API**: ビューポート検出
- **プログレッシブJPEG**: 段階的な画像表示
- **プリロード戦略**: 次に表示される可能性の高い画像を事前読み込み

#### メモリ管理

- **画像プール**: 表示中の画像の適切な管理
- **ガベージコレクション**: 非表示画像の適切な解放
- **キャッシュ戦略**: 頻繁にアクセスされる画像の保持

### 8. アクセシビリティ対応

#### キーボードナビゲーション

- **Tab順序**: 論理的なフォーカス移動
- **ショートカットキー**: 一般的なギャラリー操作のキーバインド
- **フォーカスインジケーター**: 現在のフォーカス位置の明確な表示

#### スクリーンリーダー対応

- **ARIA属性**: 適切なラベルと説明
- **セマンティックHTML**: 意味のあるHTML構造
- **代替テキスト**: 画像の適切な説明

## ビルドとデプロイ

### Pre-commitフック（Husky）

- `lint-staged`はステージされたファイルのみで実行
- リンティング問題の自動修正とコードフォーマット
- 型チェックとビルド検証
- `.husky/pre-commit`と`package.json`で設定

### ESLint設定

- フラット設定形式（ESLint 9+）で`eslint.config.mjs`
- Next.js、TypeScript、Storybookルールセット
- CIでのゼロ警告ポリシー強制
- インポートソートとコード品質ルール

### 開発ワークフロー

- パッケージマネージャーとして`pnpm`（バージョン9.12.3）
- パスエイリアスを持つ厳格なTypeScript設定
- VitestとTesting Libraryによる包括的なテスト設定
- コンポーネント開発とドキュメントのためのStorybook

## テスト戦略

### テスト構造

- VitestとReact Testing Libraryによるユニットテスト
- 分離された環境でのコンポーネントテスト
- V8カバレッジツールによるカバレッジレポート
- テストは`src/__tests__/`ディレクトリに配置

### テスト実行

- 開発には`pnpm test`を使用（ウォッチモード）
- CI環境には`pnpm test --run`を使用
- カバレッジレポートは`pnpm test:coverage`で利用可能

変更をコミットする前に、常に`pnpm type-check`と`pnpm lint-all`を実行してください。このプロジェクトは厳格なTypeScript設定を使用し、自動化されたpre-commitフックを通じてコード品質を強制しています。
